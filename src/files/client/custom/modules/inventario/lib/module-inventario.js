/**LICENSE**/
define("inventario:views/modules/semaforo",[],function(){var a=function(a){this.view=a,this.camposSemaforo={mercadeo:["fotos","copy","video","videoInsertado","metricas","rotulo"],otros:["exclusividad","precio","ubicacion","demanda"]}};return a.prototype.setupEventListeners=function(){var a=this;this.view.$el.find('[data-action="selectSemaforo"]').on("click",function(e){a.seleccionarSemaforo(e)})},a.prototype.seleccionarSemaforo=function(a){var e=$(a.currentTarget),o=e.data("campo"),i=e.data("valor");this.view.$el.find('[data-campo="'+o+'"]').removeClass("selected"),e.addClass("selected"),this.view.$el.find("#"+o).val(i),this.camposSemaforo.mercadeo.includes(o)&&this.view.calculadoraNotas.calcularNotas()},a.prototype.inicializarCampo=function(a,e){this.view.$el.find("#"+a).val(e||this.getValorPorDefecto(a)),this.view.$el.find('[data-campo="'+a+'"]').removeClass("selected");var o='[data-campo="'+a+'"][data-valor="'+(e||this.getValorPorDefecto(a))+'"]';this.view.$el.find(o).addClass("selected")},a.prototype.inicializarTodosLosCampos=function(a){this.camposSemaforo.mercadeo.forEach(function(e){this.inicializarCampo(e,a[e])}.bind(this)),this.camposSemaforo.otros.forEach(function(e){this.inicializarCampo(e,a[e])}.bind(this))},a.prototype.getValorPorDefecto=function(a){return{fotos:"Modificar",copy:"Modificar",video:"Modificar",videoInsertado:"Modificar",metricas:"Modificar",rotulo:"Modificar",precio:"En rango",ubicacion:"Modificar",exclusividad:"No exclusividad",demanda:"Media demanda"}[a]||"Modificar"},a.prototype.getValoresCampos=function(){var a={};return this.camposSemaforo.mercadeo.concat(this.camposSemaforo.otros).forEach(function(e){a[e]=this.view.$el.find("#"+e).val()||this.getValorPorDefecto(e)}.bind(this)),a},a}),define("inventario:views/modules/permisos",[],function(){var a=function(a){this.view=a,this.permisos={esAdministrativo:!1,esCasaNacional:!1,esGerente:!1,esDirector:!1,esCoordinador:!1,esAsesor:!1,claUsuario:null,oficinaUsuario:null,usuarioId:null,permisosListo:!1}};return a.prototype.cargarPermisosUsuario=function(){var a=this;return new Promise(function(e,o){var i=a.view.getUser();Espo.Ajax.getRequest("InvLista/action/getUserInfo",{userId:i.id}).then(function(t){if(t.success&&t.data){var r=t.data,s="admin"===r.userType,n=r.esGerente||r.esCoordinador||r.esDirector||r.esCasaNacional,d="regular"===r.userType&&!n;a.permisos={esAdministrativo:s,esCasaNacional:r.esCasaNacional||!1,esGerente:r.esGerente||!1,esDirector:r.esDirector||!1,esCoordinador:r.esCoordinador||!1,esAsesor:d,claUsuario:r.claUsuario||null,oficinaUsuario:r.oficinaUsuario||null,usuarioId:r.usuarioId||i.id,permisosListo:!0},e(a.permisos)}else o(t.error||"Error al cargar permisos")}).catch(o)})},a.prototype.getPermisos=function(){return this.permisos},a.prototype.puedeVerTodasLasPropiedades=function(){return this.permisos.esAdministrativo||this.permisos.esCasaNacional},a.prototype.puedeVerPropiedadesOficina=function(){return this.permisos.esGerente||this.permisos.esDirector||this.permisos.esCoordinador},a.prototype.soloPuedeVerSusPropiedades=function(){return this.permisos.esAsesor},a}),define("inventario:views/modules/modal-crear-recaudo",[],function(){var a=function(a){this.view=a,this.modalHtml=null,this.modalInicializado=!1};return a.prototype.inicializar=function(){this.modalInicializado||(this.crearModalHTML(),this.agregarModalAlDOM(),this.setupEventListeners(),this.modalInicializado=!0,console.log("ModalCrearRecaudo inicializado"))},a.prototype.crearModalHTML=function(){this.modalHtml='<div class="modal fade" id="modalCrearRecaudo" tabindex="-1" role="dialog" aria-hidden="true">  <div class="modal-dialog" role="document">    <div class="modal-content">      <div class="modal-header">        <button type="button" class="close" data-dismiss="modal" aria-label="Close">          <span aria-hidden="true">&times;</span>        </button>        <h4 class="modal-title"><i class="fas fa-plus-circle"></i> <span id="modalTitulo">Crear Nuevo Recaudo</span></h4>      </div>      <div class="modal-body">        <div class="form-group">          <label>Nombre del Recaudo *</label>          <input type="text" id="nombreRecaudo" class="form-control" placeholder="Ingrese el nombre del recaudo">        </div>        <div class="form-group">          <label>Descripción</label>          <textarea id="descripcionRecaudo" class="form-control" rows="3" placeholder="Ingrese una descripción (opcional)"></textarea>        </div>        <input type="hidden" id="tipoRecaudoModal" value="">      </div>      <div class="modal-footer">        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>        <button type="button" class="btn btn-primary" id="btnGuardarRecaudo">          <i class="fas fa-save"></i> Guardar Recaudo        </button>      </div>    </div>  </div></div>'},a.prototype.agregarModalAlDOM=function(){0===$("#modalCrearRecaudo").length&&($("body").append(this.modalHtml),console.log("Modal agregado al DOM"))},a.prototype.setupEventListeners=function(){var a=this;$(document).off("click","#btnGuardarRecaudo").on("click","#btnGuardarRecaudo",function(){a.guardarNuevoRecaudo()}),$("#modalCrearRecaudo").off("hidden.bs.modal").on("hidden.bs.modal",function(){a.limpiarCampos()}),$(document).off("keypress","#nombreRecaudo, #descripcionRecaudo").on("keypress","#nombreRecaudo, #descripcionRecaudo",function(a){13===a.which&&(a.preventDefault(),$("#btnGuardarRecaudo").click())})},a.prototype.mostrar=function(a){this.inicializar();var e=this.getTipoTexto(a);$("#modalTitulo").text("Crear Nuevo Recaudo "+e),$("#tipoRecaudoModal").val(a),setTimeout(function(){$("#nombreRecaudo").focus()},500),$("#modalCrearRecaudo").modal("show")},a.prototype.getTipoTexto=function(a){switch(a){case"legal":return"Legal";case"mercadeo":return"de Mercadeo";case"apoderado":return"de Apoderado";default:return""}},a.prototype.guardarNuevoRecaudo=function(){var a=$("#nombreRecaudo").val(),e=$("#descripcionRecaudo").val(),o=$("#tipoRecaudoModal").val();if(!a||""===a.trim())return Espo.Ui.warning("El nombre del recaudo es requerido"),void $("#nombreRecaudo").focus();var i=this.mapearTipoBackend(o),t=$("#btnGuardarRecaudo"),r=t.html();t.prop("disabled",!0).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');var s=this,n="";"legal"===o&&(n=this.view.$el.find("#tipoPersona").val());var d={nombre:a.trim(),descripcion:e.trim(),tipo:i,default:!1};"legal"===o&&n&&(d.tipoPersona=n),Espo.Ajax.postRequest("InvRecaudos/action/crearRecaudo",d).then(function(a){a.success?(Espo.Ui.success("Recaudo creado exitosamente"),$("#modalCrearRecaudo").modal("hide"),$(document).trigger("recaudoCreado.inventario",{tipo:o,recaudoId:a.data.id,recaudoNombre:a.data.name,recaudoTipo:a.data.tipo}),s.actualizarListaDespuesDeCrear(o,a.data)):Espo.Ui.error(a.error||"Error al crear recaudo")}).catch(function(a){console.error("Error al crear recaudo:",a),Espo.Ui.error("Error al crear recaudo")}).finally(function(){t.prop("disabled",!1).html(r)})},a.prototype.actualizarListaDespuesDeCrear=function(a,e){if(this.view.recaudosDinamicosManager)if(this.view.recaudosDinamicosManager.cargarSelectAgregarRecaudos(this.view.recaudosDinamicosManager.getTipoPorCampoId(a),a),"legal"===a){var o=this.view.$el.find("#tipoPersona").val();e.tipo===o&&this.view.recaudosDinamicosManager.agregarRecaudoDesdeCreacion(e.id,a)}else this.view.recaudosDinamicosManager.agregarRecaudoDesdeCreacion(e.id,a)},a.prototype.mapearTipoBackend=function(a){return{legal:["Natural","Juridico"],mercadeo:"Mercadeo",apoderado:"Apoderado"}[a]||a},a.prototype.limpiarCampos=function(){$("#nombreRecaudo").val(""),$("#descripcionRecaudo").val(""),$("#tipoRecaudoModal").val("")},a}),define("inventario:views/modules/calculadora-notas",[],function(){var a=function(a){this.view=a};return a.prototype.calcularNotas=function(){var a={legal:0,mercadeo:0},e="";e="Natural"===this.view.$el.find("#tipoPersona").val()?this.view.$el.find("#estadoLegalNatural").val():this.view.$el.find("#estadoLegalJuridico").val(),a.legal=this.calcularPorcentajeLegal(e);return a.mercadeo=this.calcularPorcentajeMercadeo(["fotos","copy","video","videoInsertado","metricas","rotulo"]),this.actualizarPorcentajesUI(a),a},a.prototype.calcularPorcentajeLegal=function(a){return"Adecuado"===a?100:"Revisar"===a?50:0},a.prototype.calcularPorcentajeMercadeo=function(a){var e=a.length,o=0;return a.forEach(function(a){"Adecuado"===this.view.$el.find("#"+a).val()&&o++}.bind(this)),e>0?Math.round(o/e*100):0},a.prototype.actualizarPorcentajesUI=function(a){this.view.$el.find("#nota-legal").text(a.legal+"%"),this.view.$el.find("#nota-mercadeo").text(a.mercadeo+"%")},a.prototype.getNotaMercadeo=function(){var a=[];return["fotos","copy","video","videoInsertado","metricas","rotulo"].forEach(function(e){var o=this.view.$el.find("#"+e).val();a.push(o||"Modificar")}.bind(this)),a.includes("Modificar")?"Modificar":a.includes("Revisar")?"Revisar":"Adecuado"},a.prototype.inicializarPorcentajes=function(){this.calcularNotas()},a}),define("inventario:views/propiedad",["view","inventario:views/modules/semaforo","inventario:views/modules/calculadora-notas","inventario:views/modules/modal-crear-recaudo"],function(a,e,o,i){return a.extend({template:"inventario:propiedad",setup:function(){if(a.prototype.setup.call(this),this.propiedadId=this.options.propiedadId,!this.propiedadId)return console.error("❌ NO HAY propiedadId"),Espo.Ui.error("ID de propiedad no proporcionado"),void this.getRouter().navigate("#InvLista",{trigger:!0});this.datosYaCargados=!1,this.cargandoDatos=!1,this.vistaYaRenderizada=!1,this.inventarioId=null,this.inventarioData=null,this.propiedadData=null,this.subBuyersSeleccionados=[],this.initializeListasRecaudos(),this.semaforoManager=new e(this),this.calculadoraNotas=new o(this),this.modalCrearRecaudo=new i(this),this.valoresRecaudosLegal={},this.valoresRecaudosMercadeo={},this.valoresRecaudosApoderado={},this.panelsInitialized=!1,this.datosCompletamenteCargados=!1,this.cargasPendientes=0,this.cargarDatos()},registrarCargaPendiente:function(){this.cargasPendientes++},marcarCargaCompletada:function(){if(this.cargasPendientes--,this.cargasPendientes<=0){this.cargasPendientes=0,this.datosCompletamenteCargados=!0,this.calcularNotasPorcentajes(),this.$el.find(".panel-body").hide(),this.$el.find(".panel-heading .fas").removeClass("fa-chevron-up").addClass("fa-chevron-down");var a=this;setTimeout(function(){a.$el.find(".panel-body").hide(),a.isRendered()&&a.inicializarPanels()},200)}},initializeListasRecaudos:function(){this.listasRecaudos={legal:{natural:{mostrados:[],disponibles:[],esPorDefecto:!1},juridico:{mostrados:[],disponibles:[],esPorDefecto:!1},tipoActual:"natural"},mercadeo:{mostrados:[],disponibles:[],esPorDefecto:!1},apoderado:{mostrados:[],disponibles:[],esPorDefecto:!1}}},afterRender:function(){if(a.prototype.afterRender.call(this),!this.vistaYaRenderizada){this.vistaYaRenderizada=!0,this.setupEventListeners(),this.calculadoraNotas&&this.calculadoraNotas.inicializarPorcentajes(),this.modalCrearRecaudo&&this.modalCrearRecaudo.inicializar(),this.actualizarEstadosOtros();var e=this;setTimeout(function(){e.$el.find(".panel-body").hide(),e.$el.find(".panel-heading .fas").removeClass("fa-chevron-up").addClass("fa-chevron-down")},100)}},inicializarPanels:function(){this.panelsInitialized||(this.panelsInitialized=!0,this.inicializarSelect2SubBuyers())},setupEventListeners:function(){var a=this;this.$el.on("click",'[data-action="toggle-panel"]',function(e){if(e.preventDefault(),e.stopPropagation(),!a.panelsInitialized||!a.datosCompletamenteCargados)return!1;a.togglePanel($(this).closest(".panel-heading")[0])}),this.$el.find("#buyerPersona").on("change",function(e){a.subBuyersSeleccionados=[],a.cargarSubBuyersDisponibles($(e.currentTarget).val())}),this.$el.on("click",'[data-action="volver"], [data-action="cancelar"]',function(){window.location.href="#InvLista",window.location.reload()}),this.$el.on("click",'[data-action="guardar"]',function(){a.guardarInventario()}),this.$el.on("change",'input[name="apoderado"]',function(e){var o="true"===$(e.currentTarget).val();a.mostrarObligaciones(o),o&&0===a.listasRecaudos.apoderado.mostrados.length&&a.cargarYMostrarRecaudosApoderado()}),this.$el.on("change","#tipoPersona",function(e){a.cargarYMostrarRecaudosLegales($(e.target).val()),a.calcularNotasPorcentajes()}),this.$el.on("change","#buyerPersona",function(e){a.cargarSubBuyersDisponibles($(e.target).val())}),this.semaforoManager&&this.semaforoManager.setupEventListeners(),this.$el.on("click",'[data-action="selectRecaudoSemaforo"]',function(e){a.seleccionarRecaudoSemaforo(e)}),this.$el.on("click",'[data-action="showInfoRecaudo"]',function(e){e.preventDefault(),e.stopPropagation(),a.mostrarInfoRecaudoModal(e)}),this.$el.on("click",'[data-action="eliminarRecaudo"]',function(e){e.preventDefault(),e.stopPropagation(),a.manejarEliminacionRecaudo(e)}),this.$el.on("click",".btn-agregar-recaudo",function(e){e.preventDefault(),a.manejarAgregarRecaudo(e)}),this.$el.on("change",".select-otros",function(e){a.manejarCambioSelectOtros(e)}),$(document).on("recaudoCreado.inventario",function(e,o){a.onRecaudoCreado(o)})},togglePanel:function(a){var e=$(a),o=e.closest(".panel").find(".panel-body"),i=e.find(".fa-chevron-down, .fa-chevron-up");o.is(":visible")?(o.hide(),i.removeClass("fa-chevron-up").addClass("fa-chevron-down")):(o.show(),i.removeClass("fa-chevron-down").addClass("fa-chevron-up"))},mostrarObligaciones:function(a){var e=this.$el.find("#contenedor-recaudos-apoderado"),o=this.$el.find("#panel-agregar-apoderado");a?(e.slideDown(200),o.slideDown(200)):(e.slideUp(200),o.slideUp(200))},cargarDatos:function(){if(!this.datosYaCargados&&!this.cargandoDatos){this.cargandoDatos=!0;var a=this;Espo.Ajax.getRequest("InvPropiedades/action/getOrCreate",{propiedadId:this.propiedadId}).then(function(e){e.success?(a.inventarioData=e.data.inventario,a.propiedadData=e.data.propiedad,a.inventarioId=a.inventarioData.id,a.datosYaCargados=!0,a.cargandoDatos=!1,a.mostrarDatos()):(a.$el.find("#loading-container").hide(),a.cargandoDatos=!1,Espo.Ui.error(e.error||"Error al cargar datos"),a.getRouter().navigate("#InvLista",{trigger:!0}))}).catch(function(e){console.error("Error en Ajax:",e),a.$el.find("#loading-container").hide(),a.cargandoDatos=!1,Espo.Ui.error("Error al cargar datos de la propiedad"),a.getRouter().navigate("#InvLista",{trigger:!0})})}},mostrarDatos:function(){this.$el.find("#loading-container").hide(),this.$el.find("#form-container").show(),this.mostrarInfoPropiedad();var a=this.inventarioData.tipoPersona||"Natural";this.$el.find("#tipoPersona").val(a),this.registrarCargaPendiente(),this.cargarYMostrarRecaudosLegales(a),this.registrarCargaPendiente(),this.mostrarInfoMercadeo(),this.mostrarInfoOtros(),this.mostrarInfoApoderado(),this.$el.find(".panel-body").hide(),this.$el.find(".panel-heading .fas").removeClass("fa-chevron-up").addClass("fa-chevron-down")},mostrarInfoPropiedad:function(){this.$el.find("#prop-tipoOperacion").text(this.propiedadData.tipoOperacion||"-"),this.$el.find("#prop-tipoPropiedad").text(this.propiedadData.tipoPropiedad||"-"),this.$el.find("#prop-subTipoPropiedad").text(this.propiedadData.subTipoPropiedad||"-"),this.$el.find("#prop-m2C").text(this.propiedadData.m2C?this.propiedadData.m2C+" m²":"-"),this.$el.find("#prop-m2T").text(this.propiedadData.m2T?this.propiedadData.m2T+" m²":"-"),this.$el.find("#prop-ubicacion").text(this.propiedadData.ubicacion||"-"),this.$el.find("#prop-asesor").text(this.propiedadData.asesorNombre||"-"),this.propiedadData.fechaAlta?this.$el.find("#prop-fechaAlta").text(new Date(this.propiedadData.fechaAlta).toLocaleDateString("es-ES")):this.$el.find("#prop-fechaAlta").text("-"),this.$el.find("#prop-diasMercado").text(this.calcularDiasEnMercado(this.propiedadData.fechaAlta));var a=this.$el.find("#prop-status");a.text(this.propiedadData.status||"-");a.css({"background-color":{Disponible:"#27ae60",Reservada:"#f39c12",Vendida:"#e74c3c",Rentada:"#3498db",Retirada:"#95a5a6","En promocion":"#27ae60"}[this.propiedadData.status]||"#95a5a6",color:"white"})},calcularDiasEnMercado:function(a){return a?Math.floor((new Date-new Date(a))/864e5)+" días":"-"},mostrarInfoMercadeo:function(){var a=this,e=this.inventarioData.buyerPersona||this.inventarioData.buyer||"Comprador";this.$el.find("#buyerPersona").val(e),this.cargarYMostrarRecaudosMercadeo().then(function(){a.marcarCargaCompletada()}).catch(function(){a.marcarCargaCompletada()}),this.cargarSubBuyersDisponibles(e),this.cargarSubBuyersSeleccionados()},mostrarInfoApoderado:function(){var a=this;this.inventarioData.apoderado||!1?(this.$el.find('input[name="apoderado"][value="true"]').prop("checked",!0),this.mostrarObligaciones(!0),this.registrarCargaPendiente(),this.cargarYMostrarRecaudosApoderado().then(function(){a.marcarCargaCompletada()}).catch(function(){a.marcarCargaCompletada()})):(this.$el.find('input[name="apoderado"][value="false"]').prop("checked",!0),this.mostrarObligaciones(!1))},mostrarInfoOtros:function(){var a=this.inventarioData.exclusividad||"Sin exclusividad",e=this.inventarioData.precio||"Fuera del rango de precio",o=this.inventarioData.ubicacion||"Ubicación no atractiva",i=this.inventarioData.demanda||"Baja demanda";this.$el.find("#select-exclusividad").val(a),this.$el.find("#select-precio").val(e),this.$el.find("#select-ubicacion").val(o),this.$el.find("#select-demanda").val(i),this.actualizarEstiloSelect("exclusividad",a),this.actualizarEstiloSelect("precio",e),this.actualizarEstiloSelect("ubicacion",o),this.actualizarEstiloSelect("demanda",i)},inicializarSelect2SubBuyers:function(){var a=this.$el.find("#subBuyerPersona");if(0!==a.length&&"function"==typeof a.select2)try{a.select2({placeholder:"Seleccione sub buyers",allowClear:!0,multiple:!0,width:"100%"})}catch(a){console.error("Error Select2:",a)}},cargarSubBuyersDisponibles:function(a){var e=this,o=this.$el.find("#subbuyers-checkbox-container");o.html('<div class="text-center" style="padding:20px;color:#999;"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>'),Espo.Ajax.getRequest("InvPropiedades/action/getSubBuyersByBuyer",{buyer:a}).then(function(a){if(a.success&&a.data&&a.data.length>0){var i="";a.data.forEach(function(a){var o=e.subBuyersSeleccionados.includes(a.id)?"checked":"";i+='<label class="subbuyer-checkbox-option">',i+='<input type="checkbox" class="subbuyer-checkbox" value="'+a.id+'" data-name="'+e.escapeHtml(a.name)+'" '+o+">",i+='<span class="checkbox-custom"></span>',i+='<span class="checkbox-label">'+e.escapeHtml(a.name)+"</span>",i+="</label>"}),o.html(i),o.find(".subbuyer-checkbox").on("change",function(){e.actualizarSubBuyersSeleccionados()})}else o.html('<div class="subbuyers-no-options"><i class="fas fa-info-circle"></i> No hay sub buyers disponibles</div>')}).catch(function(){o.html('<div class="subbuyers-no-options" style="color:#e74c3c;"><i class="fas fa-exclamation-circle"></i> Error al cargar</div>')})},actualizarSubBuyersSeleccionados:function(){this.subBuyersSeleccionados=[],this.$el.find(".subbuyer-checkbox:checked").each(function(){this.subBuyersSeleccionados.push($(this).val())}.bind(this))},cargarSubBuyersSeleccionados:function(){var a=this;this.inventarioId&&Espo.Ajax.getRequest("InvPropiedades/action/getSubBuyersPropiedad",{inventarioId:this.inventarioId}).then(function(e){e.success&&e.data&&(a.subBuyersSeleccionados=e.data.map(function(a){return a.id}),a.subBuyersSeleccionados.forEach(function(e){a.$el.find('.subbuyer-checkbox[value="'+e+'"]').prop("checked",!0)}))})},obtenerSubBuyersSeleccionados:function(){var a=[];return this.$el.find(".subbuyer-checkbox:checked").each(function(){a.push($(this).val())}),a},cargarYMostrarRecaudosLegales:function(a){var e=this,o=this.$el.find("#contenedor-recaudos-legal");return o.html('<div class="text-center" style="padding:20px;"><div class="spinner-small"></div><p>Cargando...</p></div>'),this.cargarRecaudosPorTipo("legal",a).then(function(o){var i=a.toLowerCase();return e.listasRecaudos.legal[i]=o,e.listasRecaudos.legal.tipoActual=i,e.actualizarVistaRecaudos("legal",i,o),e.actualizarDropdownRecaudos("legal",o.disponibles),e.marcarCargaCompletada(),o}).catch(function(a){o.html('<div class="alert alert-danger">Error al cargar requisitos legales</div>'),e.marcarCargaCompletada()})},cargarYMostrarRecaudosMercadeo:function(){var a=this,e=this.$el.find("#contenedor-recaudos-mercadeo");return e.html('<div class="text-center" style="padding:20px;"><div class="spinner-small"></div><p>Cargando...</p></div>'),this.cargarRecaudosPorTipo("mercadeo","Mercadeo").then(function(e){return a.listasRecaudos.mercadeo=e,a.actualizarVistaRecaudos("mercadeo",null,e),a.actualizarDropdownRecaudos("mercadeo",e.disponibles),e}).catch(function(){e.html('<div class="alert alert-danger">Error al cargar mercadeo</div>')})},cargarYMostrarRecaudosApoderado:function(){var a=this,e=this.$el.find("#contenedor-recaudos-apoderado");return this.listasRecaudos.apoderado.mostrados.length>0?(this.actualizarVistaRecaudos("apoderado",null,this.listasRecaudos.apoderado),Promise.resolve(this.listasRecaudos.apoderado)):(e.html('<div class="text-center" style="padding:20px;"><div class="spinner-small"></div><p>Cargando...</p></div>'),this.cargarRecaudosPorTipo("apoderado","Apoderado").then(function(e){return a.listasRecaudos.apoderado=e,a.actualizarVistaRecaudos("apoderado",null,e),a.actualizarDropdownRecaudos("apoderado",e.disponibles),e}).catch(function(){e.html('<div class="alert alert-danger">Error al cargar apoderado</div>')}))},cargarRecaudosPorTipo:function(a,e){var o=this;return new Promise(function(i,t){Espo.Ajax.getRequest("InvPropiedades/action/getRecaudosGuardados",{propiedadId:o.propiedadId,tipo:e}).then(function(r){if(r.success){var s=r.data.recaudos||[],n=r.data.esPorDefecto||!1;s.forEach(function(e){var i=String(e.id);"legal"===a&&(o.valoresRecaudosLegal[i]=e.estado||"Modificar/No Tiene"),"mercadeo"===a&&(o.valoresRecaudosMercadeo[i]=e.estado||"Modificar/No Tiene"),"apoderado"===a&&(o.valoresRecaudosApoderado[i]=e.estado||"Modificar/No Tiene")}),Espo.Ajax.getRequest("InvPropiedades/action/getRecaudosByTipo",{tipo:e}).then(function(a){if(a.success){var e=a.data||[],o=s.map(function(a){return String(a.id)}),r=e.filter(function(a){return!o.includes(String(a.id))});i({mostrados:s,disponibles:r,esPorDefecto:n})}else t(new Error(a.error))}).catch(t)}else t(new Error(r.error))}).catch(t)})},manejarAgregarRecaudo:function(a){var e=$(a.currentTarget).data("tipo"),o=this.$el.find("#select-agregar-"+e),i=o.val();i?"crear_nuevo"===i?(this.mostrarModalCrearRecaudo(e),o.val("")):(this.agregarRecaudo(e,i),o.val("")):Espo.Ui.warning("Por favor seleccione un elemento")},agregarRecaudo:function(a,e){e=String(e);var o=this.obtenerListaActual(a);if(this.recaudoEstaEnMostrados(o,e))Espo.Ui.warning("Ya está en la lista");else{var i=o.disponibles.findIndex(function(a){return String(a.id)===e});if(-1!==i){o.mostrados.push(o.disponibles.splice(i,1)[0]),o.esPorDefecto=!1;var t="legal"===a?this.$el.find("#tipoPersona").val().toLowerCase():null;this.actualizarVistaRecaudos(a,t,o),this.actualizarDropdownRecaudos(a,o.disponibles),Espo.Ui.success("Recaudo agregado")}else Espo.Ui.warning("No disponible")}},manejarEliminacionRecaudo:function(a){var e=$(a.currentTarget),o=String(e.data("recaudo-id")),i=e.data("campo-id");confirm("¿Desea eliminar este elemento?")&&this.eliminarRecaudo(i,o)},eliminarRecaudo:function(a,e){e=String(e);var o=this.obtenerListaActual(a),i=o.mostrados.findIndex(function(a){return String(a.id)===e});if(-1!==i){var t=o.mostrados.splice(i,1)[0];this.recaudoEstaEnDisponibles(o,e)||o.disponibles.push(t),this.eliminarValorRecaudo(a,e);var r="legal"===a?this.$el.find("#tipoPersona").val().toLowerCase():null;this.actualizarVistaRecaudos(a,r,o),this.actualizarDropdownRecaudos(a,o.disponibles),Espo.Ui.success("Recaudo eliminado")}},onRecaudoCreado:function(a){var e=a.tipo,o=String(a.recaudoId),i=this.obtenerListaActual(e);if(!this.recaudoEstaEnMostrados(i,o)&&!this.recaudoEstaEnDisponibles(i,o)){i.mostrados.push({id:o,name:a.recaudoNombre,descripcion:"",default:!1,tipo:a.recaudoTipo,estado:"Modificar/No Tiene"}),i.esPorDefecto=!1;var t="legal"===e?this.$el.find("#tipoPersona").val().toLowerCase():null;this.actualizarVistaRecaudos(e,t,i),this.actualizarDropdownRecaudos(e,i.disponibles),Espo.Ui.success("Recaudo creado y agregado")}},obtenerListaActual:function(a){if("legal"===a){var e=this.$el.find("#tipoPersona"),o=e.length?e.val():this.inventarioData.tipoPersona||"Natural";return this.listasRecaudos.legal[(o||"Natural").toLowerCase()]}return this.listasRecaudos[a]},recaudoEstaEnMostrados:function(a,e){return a.mostrados.some(function(a){return String(a.id)===String(e)})},recaudoEstaEnDisponibles:function(a,e){return a.disponibles.some(function(a){return String(a.id)===String(e)})},eliminarValorRecaudo:function(a,e){"legal"===a&&(delete this.valoresRecaudosLegal[e],this.calcularNotasPorcentajes()),"mercadeo"===a&&(delete this.valoresRecaudosMercadeo[e],this.calcularNotasPorcentajes()),"apoderado"===a&&delete this.valoresRecaudosApoderado[e]},actualizarVistaRecaudos:function(a,e,o){var i=this.$el.find("#contenedor-recaudos-"+a);0===o.mostrados.length?i.html('<div class="alert alert-info">No hay recaudos para mostrar</div>'):(i.html(this.crearHTMLRecaudos(o.mostrados,a,o.esPorDefecto)),this.inicializarTooltipsRecaudos(),this.restaurarSeleccionesRecaudos(a))},restaurarSeleccionesRecaudos:function(a){var e="legal"===a?this.valoresRecaudosLegal:"mercadeo"===a?this.valoresRecaudosMercadeo:this.valoresRecaudosApoderado;for(var o in e)e.hasOwnProperty(o)&&this.$el.find('[data-recaudo-id="'+o+'"][data-campo-id="'+a+'"][data-valor="'+e[o]+'"]').addClass("selected")},actualizarDropdownRecaudos:function(a,e){var o=this.$el.find("#select-agregar-"+a),i=this.$el.find("#panel-agregar-"+a);o.length&&(o.empty().append('<option value="">Seleccione un elemento para agregar</option>'),e&&0!==e.length?e.forEach(function(a){o.append('<option value="'+a.id+'">'+a.name+"</option>")}):o.append('<option value="" disabled>No hay elementos disponibles</option>'),o.append('<option value="crear_nuevo">+ Crear nuevo requisito</option>'),i.show())},crearHTMLRecaudos:function(a,e,o){var i=this,t='<div class="recaudos-container"><table class="table table-bordered recaudos-table"><thead><tr><th>Recaudo</th>';return"apoderado"===e?(t+='<th><i class="fas fa-circle icon-verde"></i> Lo tiene</th>',t+='<th><i class="fas fa-circle icon-rojo"></i> No lo tiene</th>'):(t+='<th><i class="fas fa-circle icon-verde"></i> Adecuado</th>',t+='<th><i class="fas fa-circle icon-amarillo"></i> Revisar</th>',t+='<th><i class="fas fa-circle icon-rojo"></i> Modificar/No Tiene</th>'),t+="<th>Acción</th></tr></thead><tbody>",a.forEach(function(a){var o=String(a.id);t+='<tr class="recaudo-row" data-recaudo-id="'+o+'">',t+='<td><div class="recaudo-texto-container">',a.descripcion&&""!==a.descripcion.trim()?t+='<span class="recaudo-icon-space"><i class="fas fa-info-circle info-icon" data-action="showInfoRecaudo" data-info="'+i.escapeHtml(a.descripcion)+'" data-recaudo-texto="'+i.escapeHtml(a.name)+'"></i></span>':t+='<span class="recaudo-icon-space"></span>',t+="<h4>"+i.escapeHtml(a.name)+"</h4></div></td>",("apoderado"===e?[{valor:"Adecuado",clase:"color-verde"},{valor:"Modificar/No Tiene",clase:"color-rojo"}]:[{valor:"Adecuado",clase:"color-verde"},{valor:"Revisar",clase:"color-amarillo"},{valor:"Modificar/No Tiene",clase:"color-rojo"}]).forEach(function(a){t+='<td><div class="color-option '+a.clase+'" data-action="selectRecaudoSemaforo" data-recaudo-id="'+o+'" data-campo-id="'+e+'" data-valor="'+a.valor+'"></div></td>'}),t+='<td><button class="btn-eliminar-recaudo" data-action="eliminarRecaudo" data-recaudo-id="'+o+'" data-campo-id="'+e+'"><i class="fas fa-minus-circle"></i></button></td>',t+="</tr>"}),t+="</tbody></table></div>"},manejarCambioSelectOtros:function(a){var e=$(a.currentTarget),o=e.data("campo"),i=e.val();this.actualizarEstiloSelect(o,i),this.calcularEstatusPropiedad()},actualizarEstiloSelect:function(a,e){var o=this.$el.find("#select-"+a);o.removeClass("select-verde select-amarillo select-rojo"),o.addClass(this.obtenerColorClassPorValor(a,e))},obtenerColorClassPorValor:function(a,e){return["Exclusividad pura o total con contrato firmado","En rango","Ubicación atractiva","Alta demanda"].includes(e)?"select-verde":["Exclusividad interna de CENTURY con contrato firmado","Cercano al rango de precio","Ubicación medianamente atractiva","Media demanda"].includes(e)?"select-amarillo":"select-rojo"},actualizarEstadosOtros:function(){["exclusividad","precio","ubicacion","demanda"].forEach(function(a){var e=this.$el.find("#select-"+a).val();e&&this.actualizarEstiloSelect(a,e)}.bind(this))},seleccionarRecaudoSemaforo:function(a){var e=$(a.currentTarget),o=e.data("recaudo-id"),i=e.data("campo-id"),t=e.data("valor");this.$el.find('[data-recaudo-id="'+o+'"][data-campo-id="'+i+'"]').removeClass("selected"),e.addClass("selected"),"legal"===i&&(this.valoresRecaudosLegal[o]=t),"mercadeo"===i&&(this.valoresRecaudosMercadeo[o]=t),"apoderado"===i&&(this.valoresRecaudosApoderado[o]=t),this.calcularNotasPorcentajes()},calcularNotasPorcentajes:function(){this.calcularPorcentajeLegal(),this.calcularPorcentajeMercadeo(),this.calcularEstatusPropiedad()},calcularPorcentajeLegal:function(){var a=this.obtenerListaActual("legal"),e=a.mostrados.length;if(0!==e){var o=a.mostrados.filter(function(a){return"Adecuado"===this.valoresRecaudosLegal[a.id]}.bind(this)).length,i=Math.round(o/e*100),t=i>=90?"#27ae60":i>=80?"#f39c12":"#e74c3c";this.$el.find("#nota-legal").html('<span class="badge-color" style="background:'+t+';"></span>')}else this.$el.find("#nota-legal").html('<span class="badge-color" style="background:#e74c3c;"></span>')},calcularPorcentajeMercadeo:function(){var a=this.listasRecaudos.mercadeo,e=a.mostrados.length;if(0!==e){var o=a.mostrados.filter(function(a){return"Adecuado"===this.valoresRecaudosMercadeo[a.id]}.bind(this)).length,i=Math.round(o/e*100),t=i>=90?"#27ae60":i>=70?"#f39c12":"#e74c3c";this.$el.find("#nota-mercadeo").html('<span class="badge-color" style="background:'+t+';"></span>')}else this.$el.find("#nota-mercadeo").html('<span class="badge-color" style="background:#e74c3c;"></span>')},calcularEstatusPropiedad:function(){var a,e=this.obtenerListaActual("legal"),o=e.mostrados.filter(function(a){return"Adecuado"===this.valoresRecaudosLegal[a.id]}.bind(this)).length,i=e.mostrados.length>0?Math.round(o/e.mostrados.length*100):0,t=i>=90?"Verde":i>=70?"Amarillo":"Rojo",r=this.listasRecaudos.mercadeo,s=r.mostrados.filter(function(a){return"Adecuado"===this.valoresRecaudosMercadeo[a.id]}.bind(this)).length,n=r.mostrados.length>0?Math.round(s/r.mostrados.length*100):0,d=n>=90?"Verde":n>=70?"Amarillo":"Rojo",c=this.$el.find("#select-precio").val(),l="En rango"===c?"Verde":"Cercano al rango de precio"===c?"Amarillo":"Rojo",u=this.$el.find("#select-exclusividad").val(),p="Exclusividad pura o total con contrato firmado"===u?"Verde":"Exclusividad interna de CENTURY con contrato firmado"===u?"Amarillo":"Rojo",h=this.$el.find("#select-ubicacion").val(),f=[t,d,l,p,"Ubicación atractiva"===h?"Verde":"Ubicación medianamente atractiva"===h?"Amarillo":"Rojo"],v=f.filter(function(a){return"Verde"===a}).length,g=(f.filter(function(a){return"Amarillo"===a}).length,f.filter(function(a){return"Rojo"===a}).length);return a=v>=4?"Verde":3===v?"Amarillo":2===v?g>=2?"Rojo":"Amarillo":"Rojo",this.estatusPropiedad=a,a},guardarInventario:function(){if(this.inventarioId){var a=this.calcularEstatusPropiedad(),e={inventarioId:this.inventarioId,tipoPersona:this.$el.find("#tipoPersona").val(),buyer:this.$el.find("#buyerPersona").val(),buyerPersona:this.$el.find("#buyerPersona").val(),subBuyers:this.obtenerSubBuyersSeleccionados(),apoderado:"true"===this.$el.find('input[name="apoderado"]:checked').val(),valoresRecaudosLegal:this.valoresRecaudosLegal,valoresRecaudosMercadeo:this.valoresRecaudosMercadeo,valoresRecaudosApoderado:this.valoresRecaudosApoderado,recaudosLegal:this.obtenerRecaudosSeleccionados("legal"),recaudosMercadeo:this.obtenerRecaudosSeleccionados("mercadeo"),recaudosApoderado:this.obtenerRecaudosSeleccionados("apoderado"),demanda:this.$el.find("#select-demanda").val(),precio:this.$el.find("#select-precio").val(),ubicacion:this.$el.find("#select-ubicacion").val(),exclusividad:this.$el.find("#select-exclusividad").val(),estatusPropiedad:a},o=this.$el.find('[data-action="guardar"]'),i=o.html();o.prop("disabled",!0).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');Espo.Ajax.postRequest("InvPropiedades/action/save",e).then(function(a){a.success?(Espo.Ui.success("Inventario guardado exitosamente"),setTimeout(function(){window.location.reload()},1e3)):(Espo.Ui.error(a.error||"Error al guardar"),o.prop("disabled",!1).html(i))}).catch(function(){Espo.Ui.error("Error al guardar inventario"),o.prop("disabled",!1).html(i)})}else Espo.Ui.error("No hay inventario para guardar")},obtenerRecaudosSeleccionados:function(a){return this.obtenerListaActual(a).mostrados.map(function(e){var o="legal"===a?this.valoresRecaudosLegal[e.id]:"mercadeo"===a?this.valoresRecaudosMercadeo[e.id]:this.valoresRecaudosApoderado[e.id];return{recaudoId:e.id,estado:o||"Modificar/No Tiene"}}.bind(this))},mostrarModalCrearRecaudo:function(a){this.modalCrearRecaudo&&this.modalCrearRecaudo.mostrar(a)},mostrarInfoRecaudoModal:function(a){var e=$(a.currentTarget).data("info"),o=$(a.currentTarget).data("recaudo-texto");if(e){var i="infoRecaudoModal",t=$("#"+i);0===t.length&&($("body").append('<div class="modal fade" id="'+i+'" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal">&times;</button><h4 class="modal-title"><i class="fas fa-info-circle"></i> Información del Recaudo</h4></div><div class="modal-body"><h5>Recaudo:</h5><p class="info-recaudo-texto"></p><h5>Descripción:</h5><div class="info-contenido-texto"></div></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button></div></div></div></div>'),t=$("#"+i)),t.find(".info-recaudo-texto").text(o),t.find(".info-contenido-texto").html(e.replace(/\n/g,"<br>")),t.modal("show")}},inicializarTooltipsRecaudos:function(){this.$el.find('[data-toggle="tooltip"]').tooltip({placement:"top",html:!0,container:"body",trigger:"hover"})},escapeHtml:function(a){return a?a.toString().replace(/[&<>"']/g,function(a){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[a]}):""},data:function(){return{}}})}),define("inventario:views/list",["view","inventario:views/modules/permisos"],function(a,e){return a.extend({template:"inventario:list",setup:function(){a.prototype.setup.call(this),this.permisosManager=new e(this),this.filtros={cla:null,oficina:null,asesor:null,fechaDesde:null,fechaHasta:null},this.propiedadesPagina=[],this.inventarioData={},this.paginacion={pagina:1,porPagina:25,total:0,totalPaginas:0},this.cargandoPagina=!1,this.cargarPermisos()},cargarPermisos:function(){this.permisosManager.cargarPermisosUsuario().then(function(a){this.permisos=a,this.cargarFiltros(),this.cargarPropiedadesIniciales()}.bind(this)).catch(function(a){console.error("Error cargando permisos:",a),this.fetchPropiedades({})}.bind(this))},afterRender:function(){a.prototype.afterRender.call(this),this.setupEventListeners(),this.aplicarVisibilidadFiltros()},aplicarVisibilidadFiltros:function(){if(this.permisos){var a=this.permisos;a.esAsesor?this.$el.find("#filtro-cla-group, #filtro-oficina-group, #filtro-asesor-group").hide():a.esGerente||a.esDirector||a.esCoordinador?(this.$el.find("#filtro-cla-group, #filtro-oficina-group").hide(),this.$el.find("#filtro-asesor-group").show()):this.$el.find("#filtro-cla-group, #filtro-oficina-group, #filtro-asesor-group").show()}},setupEventListeners:function(){var a=this;this.$el.find('[data-action="aplicar-filtros"]').on("click",function(){a.paginacion.pagina=1,a.aplicarFiltros()}),this.$el.find('[data-action="limpiar-filtros"]').on("click",function(){a.limpiarFiltros()}),this.$el.find("#filtro-cla").on("change",function(e){a.onCLAChange($(e.currentTarget).val())}),this.$el.find("#filtro-oficina").on("change",function(e){a.onOficinaChange($(e.currentTarget).val())})},cargarFiltros:function(){var a=this.permisos;if(!a.esAsesor)return a.esGerente||a.esDirector||a.esCoordinador?(this.filtros.oficina=a.oficinaUsuario,void(a.oficinaUsuario&&this.cargarAsesoresPorOficina(a.oficinaUsuario))):void this.cargarTodosCLAs();this.filtros.asesor=a.usuarioId},cargarTodosCLAs:function(){Espo.Ajax.getRequest("InvLista/action/getCLAs").then(function(a){a.success&&this.poblarSelectCLAs(a.data)}.bind(this))},poblarSelectCLAs:function(a){var e=this.$el.find("#filtro-cla");e.empty().append('<option value="">Todos los CLAs</option>'),a.forEach(function(a){e.append('<option value="'+a.id+'">'+a.name+"</option>")})},onCLAChange:function(a){var e=this.$el.find("#filtro-oficina"),o=this.$el.find("#filtro-asesor");e.html('<option value="">Cargando...</option>').prop("disabled",!0),o.html('<option value="">Todos los asesores</option>').prop("disabled",!0),a?Espo.Ajax.getRequest("InvLista/action/getOficinasByCLA",{claId:a}).then(function(a){a.success&&this.poblarSelectOficinas(a.data)}.bind(this)):e.html('<option value="">Seleccione un CLA primero</option>')},poblarSelectOficinas:function(a){var e=this.$el.find("#filtro-oficina");e.empty().append('<option value="">Todas las oficinas</option>'),a.forEach(function(a){e.append('<option value="'+a.id+'">'+a.name+"</option>")}),e.prop("disabled",!1)},onOficinaChange:function(a){var e=this.$el.find("#filtro-asesor");e.html('<option value="">Cargando...</option>').prop("disabled",!0),a?this.cargarAsesoresPorOficina(a):e.html('<option value="">Todos los asesores</option>').prop("disabled",!1)},cargarAsesoresPorOficina:function(a){var e=this;Espo.Ajax.getRequest("InvLista/action/getAsesoresByOficina",{oficinaId:a}).then(function(a){a.success?e.poblarSelectAsesores(a.data):(console.error("Error asesores:",a.error),e.$el.find("#filtro-asesor").html('<option value="">Error al cargar asesores</option>').prop("disabled",!1))}).catch(function(a){console.error("Error cargando asesores:",a),e.$el.find("#filtro-asesor").html('<option value="">Error al cargar asesores</option>').prop("disabled",!1)})},poblarSelectAsesores:function(a){var e=this.$el.find("#filtro-asesor");e.empty().append('<option value="">Todos los asesores</option>'),a&&a.length>0?a.forEach(function(a){e.append('<option value="'+a.id+'">'+a.name+"</option>")}):e.append('<option value="" disabled>Sin asesores en esta oficina</option>'),e.prop("disabled",!1)},cargarPropiedadesIniciales:function(){var a={pagina:1},e=this.permisos;e?(e.esAsesor?a.asesorId=e.usuarioId:(e.esGerente||e.esDirector||e.esCoordinador)&&e.oficinaUsuario&&(a.oficinaId=e.oficinaUsuario),this.fetchPropiedades(a)):this.fetchPropiedades(a)},aplicarFiltros:function(){var a=this.$el.find("#filtro-cla").val()||null,e=this.$el.find("#filtro-oficina").val()||null,o=this.$el.find("#filtro-asesor").val()||null;this.filtros={cla:a,oficina:e,asesor:o,fechaDesde:this.$el.find("#filtro-fecha-desde").val()||null,fechaHasta:this.$el.find("#filtro-fecha-hasta").val()||null};var i=this.permisos;i&&(i.esAsesor?(this.filtros.asesor=i.usuarioId,this.filtros.cla=null,this.filtros.oficina=null):(i.esGerente||i.esDirector||i.esCoordinador)&&(this.filtros.oficina=i.oficinaUsuario,this.filtros.cla=null)),this.paginacion.pagina=1,this.fetchConFiltrosActuales()},limpiarFiltros:function(){this.$el.find("#filtro-cla").val(""),this.$el.find("#filtro-oficina").val("").prop("disabled",!0).html('<option value="">Seleccione un CLA primero</option>'),this.$el.find("#filtro-asesor").val("").prop("disabled",!0).html('<option value="">Todos los asesores</option>'),this.$el.find("#filtro-fecha-desde").val(""),this.$el.find("#filtro-fecha-hasta").val(""),this.filtros={cla:null,oficina:null,asesor:null,fechaDesde:null,fechaHasta:null},this.paginacion.pagina=1,this.cargarPropiedadesIniciales()},fetchConFiltrosActuales:function(a){var e={pagina:a||this.paginacion.pagina};this.filtros.cla&&(e.claId=this.filtros.cla),this.filtros.oficina&&(e.oficinaId=this.filtros.oficina),this.filtros.asesor&&(e.asesorId=this.filtros.asesor),this.filtros.fechaDesde&&(e.fechaDesde=this.filtros.fechaDesde),this.filtros.fechaHasta&&(e.fechaHasta=this.filtros.fechaHasta),this.fetchPropiedades(e)},fetchPropiedades:function(a){if(!this.cargandoPagina){this.cargandoPagina=!0;var e=this.$el.find("#inventario-container");e.html(this.spinnerHTML());var o=this;Espo.Ajax.getRequest("InvLista/action/getPropiedades",a).then(function(a){o.cargandoPagina=!1,a.success?(o.propiedadesPagina=a.data||[],o.paginacion=a.paginacion||o.paginacion,o.cargarInventarioData(o.propiedadesPagina)):e.html('<div class="alert alert-danger">Error: '+(a.error||"desconocido")+"</div>")}).catch(function(a){o.cargandoPagina=!1,console.error("Error cargando propiedades:",a),e.html('<div class="alert alert-danger">Error al cargar propiedades</div>')})}},cargarInventarioData:function(a){var e=a.map(function(a){return a.id});if(0!==e.length){var o=this;Espo.Ajax.postRequest("InvLista/action/getInventarioData",{propiedadIds:e}).then(function(a){a.success&&(o.inventarioData=a.data),o.renderizarTabla()}).catch(function(){o.renderizarTabla()})}else this.renderizarTabla()},irAPagina:function(a){a<1||a>this.paginacion.totalPaginas||this.cargandoPagina||(this.paginacion.pagina=a,this.fetchConFiltrosActuales(a))},spinnerHTML:function(){return'<div class="text-center" style="padding:80px 20px;"><div class="spinner-large"></div><h4 style="color:#1A1A1A;font-weight:600;margin-top:20px;">Cargando inventario...</h4><p style="color:#666;">Obteniendo datos del servidor</p></div>'},calcularDias:function(a){return a?Math.floor((new Date-new Date(a))/864e5)+" días":"-"},colorEstatus:function(a){return"Verde"===a?"#27ae60":"Amarillo"===a?"#f39c12":"Rojo"===a?"#e74c3c":"#95a5a6"},colorDemanda:function(a){return"Alta demanda"===a?"#27ae60":"Media demanda"===a?"#f39c12":"Baja demanda"===a?"#e74c3c":"#95a5a6"},renderizarTabla:function(){var a=this,e=this.$el.find("#inventario-container"),o=this.paginacion,i=0===o.total?0:(o.pagina-1)*o.porPagina+1,t=Math.min(o.pagina*o.porPagina,o.total);if(this.$el.find("#total-propiedades-mostradas").text(0===o.total?"0":i+"–"+t+" de "+o.total),0!==this.propiedadesPagina.length){var r='<div class="tabla-wrapper">';r+='<table class="tabla-propiedades">',r+="<thead><tr>",r+='<th style="width:90px;">Días</th>',r+='<th style="min-width:180px;">Dirección</th>',r+='<th style="min-width:140px;">Asesor</th>',r+='<th style="width:110px;">Tipo</th>',r+='<th style="width:100px;">Operación</th>',r+='<th style="width:80px;text-align:center;">Estatus</th>',r+='<th style="width:100px;text-align:center;">Demanda</th>',r+='<th style="min-width:140px;">Apoderado</th>',r+='<th style="width:60px;text-align:center;">Ver</th>',r+="</tr></thead><tbody>",this.propiedadesPagina.forEach(function(e){var o=a.inventarioData[e.id]||null,i=o&&o.estatusPropiedad||"Sin calcular",t=o&&o.demanda||"Sin definir",s=a.colorEstatus(i),n=a.colorDemanda(t),d=a.calcularDias(e.fechaAlta),c=[e.calle,e.numero,e.urbanizacion].filter(Boolean).join(" ")||"-",l=e.asesorNombre||"-",u=l.length>22?l.substring(0,20)+"…":l,p="apo-"+e.id;r+='<tr data-id="'+e.id+'">',r+='<td style="text-align:center;font-weight:600;">'+d+"</td>",r+='<td title="'+a.esc(c)+'" class="td-ellipsis">'+a.esc(c)+"</td>",r+='<td title="'+a.esc(l)+'" class="td-ellipsis">'+a.esc(u)+"</td>",r+='<td class="td-ellipsis">'+a.esc(e.tipoPropiedad||"-")+"</td>",r+='<td class="td-ellipsis">'+a.esc(e.tipoOperacion||"-")+"</td>",r+='<td style="text-align:center;"><span class="badge-estado" style="background:'+s+';">'+a.esc(i)+"</span></td>",r+='<td style="text-align:center;"><span class="badge-estado" style="background:'+n+';">'+a.esc(t)+"</span></td>",o&&o.apoderado?r+='<td id="'+p+'" style="font-size:11px;"><span style="color:#999;">Cargando…</span></td>':r+='<td id="'+p+'" style="font-size:11px;color:#bbb;">Sin apoderado</td>',r+='<td style="text-align:center;">',r+='<button class="btn-ver" data-id="'+e.id+'" title="Ver inventario">',r+='<i class="fas fa-eye"></i></button>',r+="</td>",r+="</tr>"}),r+="</tbody></table></div>",r+=this.renderPaginacion(),e.html(r),this.propiedadesPagina.forEach(function(o){var i=a.inventarioData[o.id];i&&i.apoderado&&i.id&&a.cargarRecaudosApoderado(i.id,e.find("#apo-"+o.id))}),e.find("tr[data-id]").on("click",function(e){$(e.target).closest("button").length||a.verDetalle($(this).data("id"))}),e.find(".btn-ver").on("click",function(e){e.stopPropagation(),a.verDetalle($(this).data("id"))}),e.find(".pag-btn").on("click",function(){var e=parseInt($(this).data("pagina"),10);isNaN(e)||a.irAPagina(e)})}else e.html('<div class="no-data-card"><div class="no-data-icon"><i class="fas fa-home"></i></div><h3 class="no-data-title">No hay propiedades</h3><p class="no-data-text">No se encontraron propiedades "En promoción" con los filtros actuales</p></div>')},renderPaginacion:function(){var a=this.paginacion;if(a.totalPaginas<=1)return"";var e=a.pagina,o=a.totalPaginas,i=[],t=Math.max(2,e-2),r=Math.min(o-1,e+2);i.push(1),t>2&&i.push("...");for(var s=t;s<=r;s++)i.push(s);r<o-1&&i.push("..."),o>1&&i.push(o);var n='<div class="paginacion-container">';return n+='<div class="paginacion-info">Página '+e+" de "+o+"</div>",n+='<div class="paginacion-controles">',n+='<button class="pag-btn pag-nav'+(e<=1?" disabled":"")+'" data-pagina="'+(e-1)+'"'+(e<=1?" disabled":"")+">",n+='<i class="fas fa-chevron-left"></i></button>',i.forEach(function(a){n+="..."===a?'<span class="pag-ellipsis">…</span>':'<button class="pag-btn'+(a===e?" pag-activo":"")+'" data-pagina="'+a+'">'+a+"</button>"}),n+='<button class="pag-btn pag-nav'+(e>=o?" disabled":"")+'" data-pagina="'+(e+1)+'"'+(e>=o?" disabled":"")+">",n+='<i class="fas fa-chevron-right"></i></button>',n+="</div></div>"},cargarRecaudosApoderado:function(a,e){Espo.Ajax.getRequest("InvPropiedades/action/getRecaudosApoderado",{inventarioId:a}).then(function(a){if(a.success&&a.data&&a.data.recaudos&&a.data.recaudos.length>0){var o=a.data.recaudos.filter(function(a){return"Adecuado"===a.estado});0===o.length?e.html('<span style="color:#999;">Sin recaudos</span>'):e.html(o.map(function(a){return'<div style="line-height:1.4;margin-bottom:2px;">• '+a.name+"</div>"}).join(""))}else e.html('<span style="color:#bbb;">Sin recaudos</span>')}).catch(function(){e.html('<span style="color:#e74c3c;">Error</span>')})},verDetalle:function(a){this.getRouter().navigate("#InvLista/propiedad/propiedadId="+a,{trigger:!0})},esc:function(a){return a?String(a).replace(/[&<>"']/g,function(a){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[a]}):""}})}),define("inventario:views/modules/subbuyer",[],function(){var a=function(a){this.view=a,this.$select=null,this.subBuyerSeleccionado=null};return a.prototype.setupEventListeners=function(){var a=this;this.view.$el.find("#buyerPersona").on("change",function(e){var o=$(e.target).val();a.cargarSubBuyers(o)})},a.prototype.inicializar=function(){this.$select=this.view.$el.find("#subBuyerPersona");var a=this.view.$el.find("#buyerPersona").val();a&&this.cargarSubBuyers(a)},a.prototype.cargarSubBuyers=function(a){var e=this;a?(this.$select.html('<option value="">Cargando sub buyers...</option>'),Espo.Ajax.getRequest("InvPropiedades/action/getSubBuyers",{buyer:a}).then(function(a){a.success&&a.data&&a.data.length>0?(e.$select.empty(),e.$select.append('<option value="">Seleccione un sub buyer</option>'),a.data.forEach(function(a){e.$select.append('<option value="'+a.id+'">'+a.name+"</option>")}),e.subBuyerSeleccionado&&e.seleccionarSubBuyerPorValor(e.subBuyerSeleccionado)):e.$select.html('<option value="">No hay sub buyers disponibles</option>')}.bind(this)).catch(function(a){console.error("Error cargando sub buyers:",a),e.$select.html('<option value="">Error al cargar sub buyers</option>')})):this.$select.html('<option value="">Seleccione un Buyer Persona primero</option>')},a.prototype.setValorInicial=function(a){this.subBuyerSeleccionado=a,this.$select&&this.$select.find("option").length>1&&this.seleccionarSubBuyerPorValor(a)},a.prototype.seleccionarSubBuyerPorValor=function(a){if(a&&this.$select){var e=this.$select.find("option").filter(function(){return $(this).text()===a});e.length>0&&this.$select.val(e.val())}},a.prototype.getSubBuyerSeleccionado=function(){var a=this.$select.find("option:selected").text();return"Seleccione un sub buyer"!==a&&"Cargando sub buyers..."!==a&&"No hay sub buyers disponibles"!==a&&"Error al cargar sub buyers"!==a?a:""},a}),define("inventario:controllers/inv-lista",["controllers/base"],function(a){return a.extend({defaultAction:"list",checkAccess:function(){return!0},actionList:function(){console.log("=== inv-lista.js - actionList ==="),this.main("inventario:views/list",{},function(a){a.render()})},actionPropiedad:function(a){console.log("=== inv-lista.js - actionPropiedad ==="),console.log("Params:",a);var e=a.propiedadId;if(!e)return console.error("❌ No se proporcionó propiedadId"),Espo.Ui.error("ID de propiedad no proporcionado"),void this.getRouter().navigate("#InvLista",{trigger:!0});console.log("✅ Cargando propiedad ID:",e),this.main("inventario:views/propiedad",{propiedadId:e},function(a){console.log("Vista propiedad renderizada"),a.render()})}})});